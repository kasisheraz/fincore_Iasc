name: Test Secret Validation

on:
  workflow_dispatch:
  push:
    branches:
      - develop

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check if secret exists and is valid JSON
        run: |
          echo "Checking GCP_SA_KEY secret..."
          
          if [ -z "$GCP_SA_KEY" ]; then
            echo "❌ SECRET IS EMPTY OR NOT ACCESSIBLE"
            exit 1
          fi
          
          echo "✅ Secret is accessible"
          echo "Secret length: ${#GCP_SA_KEY} characters"
          
          # Validate JSON structure
          echo "$GCP_SA_KEY" | jq . > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "✅ Secret is valid JSON"
            
            # Check required fields (without exposing values)
            PROJECT_ID=$(echo "$GCP_SA_KEY" | jq -r '.project_id')
            CLIENT_EMAIL=$(echo "$GCP_SA_KEY" | jq -r '.client_email')
            TYPE=$(echo "$GCP_SA_KEY" | jq -r '.type')
            
            echo "✅ Type: $TYPE"
            echo "✅ Project ID: $PROJECT_ID"
            echo "✅ Client Email: $CLIENT_EMAIL"
            
            if [ "$TYPE" != "service_account" ]; then
              echo "❌ Type should be 'service_account'"
              exit 1
            fi
            
            if [ "$PROJECT_ID" != "project-07a61357-b791-4255-a9e" ]; then
              echo "❌ Wrong project ID"
              exit 1
            fi
            
            echo "✅ ALL VALIDATIONS PASSED"
          else
            echo "❌ Secret is NOT valid JSON"
            exit 1
          fi
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
