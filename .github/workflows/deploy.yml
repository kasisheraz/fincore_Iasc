name: ğŸš€ Fincore Infrastructure Deployment

# Auto-deploy to NPE on develop push
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'npe'
        type: choice
        options:
          - npe
          - prod
      
      terraform_action:
        description: 'Terraform Action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      
      deploy_permissions:
        description: 'Deploy Database Permissions'
        required: true
        default: true
        type: boolean
      
      run_tests:
        description: 'Run Infrastructure Tests'
        required: true
        default: true
        type: boolean
      
      auto_approve:
        description: 'Auto-approve Terraform apply (use with caution)'
        required: true
        default: false
        type: boolean

  push:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**'
      - '.github/workflows/**'

  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**'

env:
  TF_VAR_project_id: ${{ vars.GCP_PROJECT_ID }}
  TF_IN_AUTOMATION: true
  TF_INPUT: false

jobs:
  validate:
    name: ğŸ” Validate Terraform
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Set Environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=npe" >> $GITHUB_OUTPUT
          else
            echo "environment=npe" >> $GITHUB_OUTPUT
          fi

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.6.0'
          terraform_wrapper: false

      - name: ï¿½ğŸ” Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: ğŸ› ï¸ Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: âœ… Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: ğŸš€ Terraform Init
        run: |
          cd terraform
          terraform init -backend-config="environments/${{ steps.set-env.outputs.environment }}/backend.conf"

      - name: âœ… Terraform Validate
        run: |
          cd terraform
          terraform validate

  plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ needs.validate.outputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.6.0'
          terraform_wrapper: false

      - name: ğŸ” Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: ğŸ› ï¸ Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Terraform Init
        run: |
          cd terraform
          terraform init -backend-config="environments/${{ needs.validate.outputs.environment }}/backend.conf"

      - name: ğŸ“‹ Terraform Plan
        id: plan
        run: |
          cd terraform
          set +e
          terraform plan \
            -var-file="environments/${{ needs.validate.outputs.environment }}/terraform.tfvars" \
            -out=tfplan \
            -detailed-exitcode
          EXITCODE=$?
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true


      - name: ğŸ“Š Plan Summary
        run: |
          cd terraform
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.validate.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "Exit Code: ${{ steps.plan.outputs.exitcode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "âœ… Plan contains changes" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Plan failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ğŸ’¾ Upload Plan Artifact
        if: steps.plan.outputs.exitcode == '0' || steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.validate.outputs.environment }}
          path: terraform/tfplan
          retention-days: 5

  apply:
    name: ğŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: [validate, plan]
    environment: ${{ needs.validate.outputs.environment }}
    if: |
      needs.plan.result == 'success' &&
      ((github.event_name == 'workflow_dispatch' && 
        github.event.inputs.terraform_action == 'apply') ||
       (github.event_name == 'push' && 
        github.ref == 'refs/heads/develop' && 
        needs.validate.outputs.environment == 'npe'))
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.6.0'
          terraform_wrapper: false

      - name: ğŸ” Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: ğŸ› ï¸ Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Terraform Init
        run: |
          cd terraform
          terraform init -backend-config="environments/${{ needs.validate.outputs.environment }}/backend.conf"

      - name: ğŸ’¾ Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.validate.outputs.environment }}
          path: terraform/

      - name: ğŸš€ Terraform Apply
        run: |
          cd terraform
          if [[ "${{ github.event.inputs.auto_approve }}" == "true" ]]; then
            terraform apply -auto-approve tfplan
          else
            terraform apply tfplan
          fi

      - name: ğŸ“Š Apply Summary
        run: |
          echo "## Terraform Apply Completed" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.validate.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date)" >> $GITHUB_STEP_SUMMARY

  deploy-permissions:
    name: ğŸ” Deploy Database Permissions
    runs-on: ubuntu-latest
    needs: [validate, apply]
    environment: ${{ needs.validate.outputs.environment }}
    if: |
      always() && 
      needs.apply.result == 'success' &&
      (github.event_name != 'workflow_dispatch' || 
       github.event.inputs.deploy_permissions == 'true')
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.6.0'
          terraform_wrapper: false

      - name: ğŸ” Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: ğŸ› ï¸ Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Initialize Permissions Module
        run: |
          cd terraform
          terraform init -backend-config="environments/${{ needs.validate.outputs.environment }}/backend.conf"

      - name: ğŸ” Deploy Database Permissions
        run: |
          cd terraform
          terraform apply \
            -target=module.database_permissions \
            -var-file="environments/${{ needs.validate.outputs.environment }}/terraform.tfvars" \
            -auto-approve

      - name: âœ… Permissions Summary
        run: |
          echo "## Database Permissions Deployed" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.validate.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "Database: fincore_db" >> $GITHUB_STEP_SUMMARY
          echo "User: fincore_app" >> $GITHUB_STEP_SUMMARY

  test:
    name: ğŸ§ª Infrastructure Tests
    runs-on: ubuntu-latest
    needs: [validate, apply, deploy-permissions]
    environment: ${{ needs.validate.outputs.environment }}
    if: |
      always() &&
      (needs.apply.result == 'success' || needs.apply.result == 'skipped') &&
      (github.event_name != 'workflow_dispatch' || 
       github.event.inputs.run_tests == 'true')
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: ğŸ› ï¸ Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ§ª Run Infrastructure Tests
        run: |
          chmod +x test-npe-infrastructure.sh
          ./test-npe-infrastructure.sh
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          REGION: europe-west2
          ENVIRONMENT: ${{ needs.validate.outputs.environment }}

      - name: ğŸ“Š Test Summary
        run: |
          echo "## Infrastructure Tests Completed" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.validate.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [validate, plan]
    if: always()
    
    steps:
      - name: ğŸ—‘ï¸ Cleanup Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: tfplan-${{ needs.validate.outputs.environment }}
        continue-on-error: true